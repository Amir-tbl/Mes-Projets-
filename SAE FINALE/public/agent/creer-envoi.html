<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cr√©er un envoi ‚Äî √âtape 1</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/styles.css" />
</head>
<body class="page-wizard">
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <div class="logoBox">
        <span class="logoWordmark" aria-label="Logo Universit√© Sorbonne Paris Nord"></span>
        <img src="../assets/img/logo.png" alt="Universit√© Sorbonne Paris Nord" class="logoImg">
      </div>

      <!-- Slot : la recherche est d√©plac√©e ici en mobile -->
      <div id="navSearchSlot" class="navSearchSlot" aria-hidden="true"></div>

      <nav class="nav" aria-label="Navigation principale">
        <a href="index.html">
          <span class="icon">üè†</span> Tableau de bord
          <!-- ‚¨ÖÔ∏è Remplacez l‚Äôemoji par votre ic√¥ne -->
        </a>
        <a href="creer-envoi.html" class="active">
          <span class="icon">üì¶</span> Cr√©er un envoi
        </a>
        <a href="historique.html">
          <span class="icon">üïí</span> Historique
        </a>
        <a href="#">
          <span class="icon">üë§</span> Profil
        </a>
      </nav>
    </aside>

    <!-- Overlay mobile -->
    <div id="overlay" class="overlay" hidden></div>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <button id="burger" class="burger" aria-label="Ouvrir le menu" aria-controls="sidebar" aria-expanded="false">
          <span class="i-burger" aria-hidden="true"></span>
          <!-- ‚¨ÖÔ∏è Vous pouvez mettre votre ic√¥ne menu.svg -->
        </button>

        <div class="title">CR√âER UN ENVOI</div>

        <!-- Recherche (sera d√©plac√©e en mobile dans la sidebar) -->
        <div id="topSearch" class="search" role="search">
          <span class="search-icon" aria-hidden="true"></span>
          <input id="searchInput" type="text" placeholder="Rechercher un num√©ro de suivi" aria-label="Rechercher un num√©ro de suivi" />
        </div>
      </header>

      <section class="content">
        <!-- Stepper -->
        <div class="wizard-steps card" aria-label="Progression">
          <div class="step is-active">
            <span class="step-index">1</span>
            <span class="step-label">Infos g√©n√©rales</span>
          </div>
          <div class="step">
            <span class="step-index">2</span>
            <span class="step-label">Fournisseur & Articles</span>
          </div>
          <div class="step">
            <span class="step-index">3</span>
            <span class="step-label">Livraison & Validation</span>
          </div>
        </div>

        <!-- Formulaire √âtape 1 -->
        <form id="formStep1" class="card wizard-form" novalidate>
          <fieldset class="field-grid">
            <legend class="sr-only">Informations g√©n√©rales</legend>

            <!-- Demandeur (auto) -->
            <div class="fblock">
              <label for="demandeur">Demandeur</label>
              <input id="demandeur" type="text" value="Butelle Franck" readonly aria-readonly="true" />
            </div>

            <!-- D√©partement -->
            <div class="fblock">
              <label for="departement">D√©partement</label>
              <select id="departement" required>
                <option value="">S√©lectionner‚Ä¶</option>
                <option>INFO</option>
                <option>GEA</option>
                <option>TC</option>
                <option>STID</option>
              </select>
            </div>

            <!-- Titre de la demande -->
            <div class="fblock wide">
              <label for="titre">Titre de la demande</label>
              <input id="titre" type="text" placeholder="Ex. Poste de travail complet salle B-204" required />
            </div>

            <!-- Description -->
            <div class="fblock wide">
              <label for="description">Description</label>
              <textarea id="description" rows="4" placeholder="Objectif de l'achat, contexte, pr√©cisions utiles‚Ä¶" required></textarea>
            </div>

            <!-- Budget estim√© -->
            <!-- <div class="fblock">
              <label for="budget">Budget estim√© (‚Ç¨)</label>
              <input id="budget" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0,00" required />
            </div> -->

            <!-- Date de livraison souhait√©e -->
            <div class="fblock">
              <label for="dateSouhaitee">Date livraison souhait√©e</label>
              <input id="dateSouhaitee" type="date" required />
            </div>

            <!-- Lieu de livraison -->
            <div class="fblock wide">
              <label for="lieu">Lieu de livraison</label>
              <input id="lieu" type="text" placeholder="Ex. B√¢timent A, Bureau 3.12" required />
            </div>
          </fieldset>

          <!-- Actions -->
          <div class="wizard-actions">
            <button type="button" class="btn btn-ghost" id="btnCancel">Annuler</button>
            <button type="button" class="btn btn-ghost" id="btnDraft">Sauvegarder brouillon</button>
            <button type="submit" class="btn" id="btnNext">Continuer</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/app-creer.js"></script>
  <script>
  /* Step1 -> localStorage : demandeur, description, livraison (date & lieu) ‚Äî version robuste */
  (function(){
    function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    ready(function(){
      const form = document.getElementById('formStep1') || document.querySelector('form');
      const goNextLink = document.querySelector('a[href*="creer-envoi-step2"]');
      const goNextBtn  = document.getElementById('btnNext') || document.querySelector('[data-next-step]');

      // ------- utils -------
      const val = el => !el ? '' : (el.value != null ? String(el.value).trim()
                          : (el.querySelector('input,textarea,select')?.value || el.textContent || '')).trim();
      const by = sel => document.querySelector(sel);
      const first = arr => arr.find(Boolean);
      function firstVal(selectors){
        for(const sel of selectors){ const v = val(by(sel)); if(v) return v; }
        return '';
      }
      function labelFor(el){
        if(!el) return '';
        // label[for=id]
        if(el.id){
          const l = document.querySelector(`label[for="${el.id}"]`);
          if(l) return l.textContent.toLowerCase();
        }
        // label juste avant dans un bloc
        let p = el.previousElementSibling;
        if(p && p.tagName==='LABEL') return p.textContent.toLowerCase();
        // cherche un label anc√™tre proche
        const lbl = el.closest('.fblock, .field, .form-group')?.querySelector('label');
        return lbl ? lbl.textContent.toLowerCase() : '';
      }
      function findByLabel(keywords, preferSelector=''){
        // 1) s√©lecteur privil√©gi√© si fourni
        if(preferSelector){
          const cand = by(preferSelector);
          if(cand) return cand;
        }
        // 2) search inputs/textarea/select et matche label
        const candidates = [...document.querySelectorAll('input, textarea, select')];
        const keys = keywords.map(k => k.toLowerCase());
        for(const el of candidates){
          const txt = labelFor(el);
          const idn = (el.id || '').toLowerCase();
          const nm  = (el.name || '').toLowerCase();
          const ph  = (el.getAttribute('placeholder') || '').toLowerCase();
          const hay = [txt, idn, nm, ph].join(' ');
          if(keys.every(k => hay.includes(k))) return el;
        }
        return null;
      }

      // ------- collecte -------
      function collect(){
        const demandeur   = firstVal(['#demandeur','#requester','#requesterName','#fromName','[name="demandeur"]','[name="requester"]']);
        const description = firstVal(['#description','#desc','#orderDescription','[name="description"]','[name="desc"]']);

        // DATE estim√©e : priorise input[type=date], puis label contenant "date" + "livraison"
        let dateEl = first([
          by('input[type="date"]#deliveryDate'),
          by('input[type="date"]#livraisonDate'),
          by('input[type="date"][name*="livraison"]'),
          by('input[type="date"][name*="delivery"]')
        ]) || findByLabel(['date','livraison']) || findByLabel(['date','estim']);
        const livraisonDateEstimee = val(dateEl) || firstVal(['#deliveryDate','#livraisonDate','#estimatedDate','[name="deliveryDate"]','[name="livraisonDate"]']);

        // LIEU souhait√© : label/fiels avec ‚Äúlieu/destination/adresse‚Äù + ‚Äúlivraison‚Äù
        let lieuEl = first([
          by('#deliveryPlace'),
          by('#livraisonLieu'),
          by('#destination'),
          by('#toAddress'),
          by('[name="deliveryPlace"]'),
          by('[name="livraisonLieu"]'),
          by('[name="destination"]')
        ]) || findByLabel(['lieu','livraison'])
          || findByLabel(['destination'])
          || findByLabel(['adresse','livraison'])
          || findByLabel(['adresse','destination']);
        const livraisonLieuSouhaite = val(lieuEl);

        return { demandeur, description, livraisonDateEstimee, livraisonLieuSouhaite };
      }

      function mergeSave(obj){
        let prev = {};
        try{ prev = JSON.parse(localStorage.getItem('wizardRequest') || '{}'); }catch(e){}
        const merged = {...prev};
        Object.entries(obj).forEach(([k,v])=>{
          if(v !== undefined && v !== null && String(v).trim() !== '') merged[k] = v;
        });
        localStorage.setItem('wizardRequest', JSON.stringify(merged));
      }

      function saveNow(){ mergeSave(collect()); }

      // √©v√®nements
      form && form.addEventListener('submit', saveNow);
      goNextLink && goNextLink.addEventListener('click', saveNow);
      goNextBtn && goNextBtn.addEventListener('click', saveNow);

      // Sauvegarde live si l‚Äôutilisateur remplit/edite
      document.addEventListener('change', (e)=>{
        const t = e.target;
        if(!(t instanceof HTMLElement)) return;
        const lbl = labelFor(t);
        const idn = (t.id||'') + ' ' + (t.name||'') + ' ' + (t.getAttribute('placeholder')||'');
        const s = (lbl + ' ' + idn).toLowerCase();
        if(/(livraison|delivery).*(lieu|place|destination|adresse)/.test(s) || /(date).*(livraison|delivery)/.test(s)){
          saveNow();
        }
      });
    });
  })();
</script>



</body>
</html>
